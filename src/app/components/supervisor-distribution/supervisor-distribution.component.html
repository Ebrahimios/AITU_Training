<div class="distribution-container">
  <!-- Header -->
  <div class="header">
    <div class="back-button">
      <button class="btn btn-light" routerLink="/home">
        <i class="bi bi-arrow-left"></i>
        {{ translationService.translate('back_to_home') }}
      </button>
    </div>
    <div class="header-content">
      <h2>{{ translationService.translate('students_distribution') }}</h2>
      <div class="filters">
        <div class="search-box">
          <i class="bi bi-search"></i>
          <input
            type="text"
            [(ngModel)]="searchTerm"
            placeholder="Search students..."
          >
        </div>
        <div class="add-factory-button">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFactoryModal">
            Add Factory
          </button>
        </div>
        <select [(ngModel)]="selectedDepartment">
          <option *ngFor="let dept of departments" [value]="dept">
            {{dept}} Department
          </option>
        </select>

        <select [(ngModel)]="selectedStage">
          <option *ngFor="let stage of stages" [value]="stage">
            {{stage}} Stage
          </option>
        </select>

        <select [(ngModel)]="selectedBatch">
          <option *ngFor="let batch of batches" [value]="batch">
            {{batch}} Batch
          </option>
        </select>

        <select [(ngModel)]="selectedFactoryType">
          <option *ngFor="let type of factoryTypes" [value]="type">{{type}} Factories</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content">
    <!-- Students List -->
    <div class="students-list">
      <div class="students-header">
        <h3>Students ({{filteredStudents.length}})</h3>
        <div class="selection-controls">
          <label class="select-all-checkbox">
            <input type="checkbox"
                   [checked]="selectAll"
                   (change)="toggleSelectAll()">
            <span>Select All</span>
          </label>
          <div class="selection-info" *ngIf="selectedStudents.length > 0">
            {{selectedStudents.length}} students selected
          </div>
        </div>
      </div>

      <div class="students-container"
           cdkDropList
           #studentList="cdkDropList"
           [cdkDropListData]="filteredStudents"
           [cdkDropListConnectedTo]="factoryDropLists"
           (cdkDropListDropped)="onDrop($event)">
        <div class="student-card"
             *ngFor="let student of filteredStudents"
             cdkDrag
             [cdkDragData]="student"
             [class.selected]="student.selected">
          <div class="checkbox-wrapper">
            <input type="checkbox"
                   [checked]="student.selected"
                   (click)="toggleSelection($event, student)">
          </div>
          <div class="student-info" (click)="toggleSelection($event, student)">
            <h4>{{student.name}}</h4>
            <p>{{student.department}} | {{student.stage}} | {{student.batch}}</p>
          </div>
          <div class="student-factory">
            <span *ngIf="student.factory" class="factory-badge">
              {{student.factory}}
              <button class="remove-btn" (click)="removeFromFactory(student, $event)">
                <i class="bi bi-x"></i>
              </button>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Factories -->
    <div class="factories-container">
      <div class="factories-header">
        <h3>Factories</h3>
        <div class="factory-search">
          <i class="bi bi-search"></i>
          <input
            type="text"
            [(ngModel)]="factorySearchTerm"
            placeholder="Search factories..."
          >
        </div>
      </div>
      <div class="factories-grid">
        <div class="factory-card" *ngFor="let factory of filteredFactories"
             [class.full]="factory.assignedStudents >= factory.capacity"
             (click)="openFactoryDetails(factory)">
          <div class="factory-header">
            <h3>{{ factory.name }}</h3>
            <span class="capacity">{{ factory.assignedStudents }}/{{ factory.capacity }}</span>
          </div>
          <div class="progress-bar">
            <div class="progress"
                 [style.width.%]="(factory.assignedStudents / factory.capacity) * 100"
                 [ngClass]="{
                   'empty': factory.assignedStudents === 0,
                   'low': factory.assignedStudents > 0 && factory.assignedStudents < factory.capacity * 0.5,
                   'medium': factory.assignedStudents >= factory.capacity * 0.5 && factory.assignedStudents < factory.capacity * 0.8,
                   'high': factory.assignedStudents >= factory.capacity * 0.8
                 }">
            </div>
          </div>
          <div class="factory-students"
               cdkDropList
               [id]="'factory-' + factory.id"
               [cdkDropListData]="factory.students"
               [cdkDropListConnectedTo]="[studentList]"
               (cdkDropListDropped)="onDrop($event, factory)">
            <div class="dropzone-content" *ngIf="factory.students.length === 0">
              <i class="bi bi-plus-circle"></i>
              <span *ngIf="factory.assignedStudents < factory.capacity">
                Drag students here
              </span>
              <span *ngIf="factory.assignedStudents >= factory.capacity">
                Factory is full
              </span>
            </div>

            <div class="assigned-students">
              <div class="assigned-student" *ngFor="let student of factory.students">
                <span class="student-name">{{student.name}}</span>
                <button class="remove-btn" (click)="removeFromFactory(student, $event)">
                  <i class="bi bi-x"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Factory Modal -->
    <div class="modal fade" id="addFactoryModal" tabindex="-1" aria-labelledby="addFactoryModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addFactoryModalLabel">Add New Factory</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="factoryName" class="form-label">Factory Name</label>
                <input type="text" class="form-control" id="factoryName" #factoryName placeholder="Enter factory name">
                <div class="text-danger" *ngIf="nameError">{{nameError}}</div>
              </div>
              <div class="mb-3">
                <label for="factoryAddress" class="form-label">Address</label>
                <input type="text" class="form-control" id="factoryAddress" #factoryAddress placeholder="Enter address">
                <div class="text-danger" *ngIf="addressError">{{addressError}}</div>
              </div>
              <div class="mb-3">
                <label for="factoryPhone" class="form-label">Phone Number</label>
                <input type="text" class="form-control" id="factoryPhone" #factoryPhone placeholder="Enter phone number">
                <div class="text-danger" *ngIf="phoneError">{{phoneError}}</div>
              </div>
              <div class="mb-3">
                <label for="factoryContactName" class="form-label">Contact Name</label>
                <input type="text" class="form-control" id="factoryContactName" #factoryContactName placeholder="Enter contact person name">
                <div class="text-danger" *ngIf="contactNameError">{{contactNameError}}</div>
              </div>
              <div class="mb-3">
                <label for="factoryIndustry" class="form-label">Industry</label>
                <div class="input-group">
                  <select class="form-select" id="factoryIndustry" #factoryIndustry>
                    <option value="" disabled selected>Select industry</option>
                    <option *ngFor="let industry of industries" [value]="industry">{{industry}}</option>
                  </select>
                  <input type="text" class="form-control" placeholder="Add new industry" [(ngModel)]="newIndustry" name="newIndustry">
                  <button class="btn btn-outline-secondary" type="button" (click)="addNewIndustry()">
                    <i class="bi bi-plus"></i> Add
                  </button>
                </div>
                <div class="text-danger" *ngIf="industryError">{{industryError}}</div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" (click)="addFactory(factoryName.value, factoryAddress.value, factoryPhone.value, factoryIndustry.value, factoryContactName.value)">Save Factory</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Factory Details Modal -->
    <div class="modal fade" id="factoryDetailsModal" tabindex="-1" aria-labelledby="factoryDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="factoryDetailsModalLabel">Factory Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" *ngIf="selectedFactory">
            <form>
              <div class="mb-3">
                <label class="form-label"><strong>Factory Name:</strong></label>
                <input type="text" class="form-control" [(ngModel)]="selectedFactory.name" name="factoryName" [readonly]="!isEditing">
              </div>
              <div class="mb-3">
                <label class="form-label"><strong>Address:</strong></label>
                <input type="text" class="form-control" [(ngModel)]="selectedFactory.address" name="factoryAddress" [readonly]="!isEditing">
              </div>
              <div class="mb-3">
                <label class="form-label"><strong>Phone:</strong></label>
                <input type="text" class="form-control" [(ngModel)]="selectedFactory.phone" name="factoryPhone" [readonly]="!isEditing">
              </div>
              <div class="mb-3">
                <label class="form-label"><strong>Contact Name:</strong></label>
                <input type="text" class="form-control" [(ngModel)]="selectedFactory.contactName" name="factoryContactName" [readonly]="!isEditing">
              </div>
              <div class="mb-3">
                <label class="form-label"><strong>Industry:</strong></label>
                <div class="input-group">
                  <select class="form-select" [(ngModel)]="selectedFactory.industry" name="factoryIndustry" [disabled]="!isEditing">
                    <option value="" disabled selected>Select industry</option>
                    <option *ngFor="let industry of industries" [value]="industry">{{industry}}</option>
                  </select>
                  <input type="text" class="form-control" placeholder="Add new industry" [(ngModel)]="newIndustry" name="newIndustry" [disabled]="!isEditing">
                  <button class="btn btn-outline-secondary" type="button" (click)="addNewIndustry()" [disabled]="!isEditing">
                    <i class="bi bi-plus"></i> Add
                  </button>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label"><strong>Capacity:</strong></label>
                <input type="number" class="form-control" [(ngModel)]="selectedFactory.capacity" name="factoryCapacity" min="1" [readonly]="!isEditing">
              </div>
              <div class="mb-3">
                <label class="form-label"><strong>Type:</strong></label>
                <select class="form-select" [(ngModel)]="selectedFactory.type" name="factoryType" [disabled]="!isEditing">
                  <option *ngFor="let type of factoryTypes.slice(1)" [value]="type">{{type}}</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label"><strong>Assigned Students:</strong></label>
                <ul class="list-group">
                  <li class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let student of selectedFactory.students">
                    {{student.name}} ({{student.department}} - {{student.stage}})
                    <button class="btn btn-sm btn-outline-danger" (click)="removeFromFactory(student, $event)">
                      <i class="bi bi-x"></i>
                    </button>
                  </li>
                  <li class="list-group-item text-muted" *ngIf="selectedFactory.students.length === 0">
                    No students assigned
                  </li>
                </ul>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" *ngIf="!isEditing" (click)="startEditing()">
              <i class="bi bi-pencil"></i> Edit
            </button>
            <button type="button" class="btn btn-success" *ngIf="isEditing" (click)="saveChanges()">
              <i class="bi bi-check"></i> Save Changes
            </button>
            <button type="button" class="btn btn-secondary" *ngIf="isEditing" (click)="cancelEditing()">
              <i class="bi bi-x"></i> Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
